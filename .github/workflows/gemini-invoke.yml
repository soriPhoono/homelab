name: "▶️ Gemini Invoke"
on:
  workflow_call:
    inputs:
      additional_context:
        type: "string"
        description: "Any additional context from the request"
        required: false
concurrency:
  group: "${{ github.workflow }}-invoke-${{ github.event_name }}-${{ github.event.pull_request.number || github.event.issue.number }}"
  cancel-in-progress: false
defaults:
  run:
    shell: "bash"
jobs:
  invoke:
    runs-on: "ubuntu-latest"
    permissions:
      contents: "write"
      id-token: "write"
      issues: "write"
      pull-requests: "write"
    steps:
      - name: "Mint identity token"
        id: "mint_identity_token"
        if: |-
          ${{ vars.APP_ID }}
        uses: "actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf" # ratchet:actions/create-github-app-token@v2
        with:
          app-id: "${{ vars.APP_ID }}"
          private-key: "${{ secrets.APP_PRIVATE_KEY }}"
          permission-contents: "write"
          permission-issues: "write"
          permission-pull-requests: "write"
      - name: "Run Gemini CLI"
        id: "run_gemini"
        uses: "google-github-actions/run-gemini-cli@v0" # ratchet:exclude
        env:
          TITLE: "${{ github.event.pull_request.title || github.event.issue.title }}"
          DESCRIPTION: "${{ github.event.pull_request.body || github.event.issue.body }}"
          EVENT_NAME: "${{ github.event_name }}"
          GITHUB_TOKEN: "${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}"
          IS_PULL_REQUEST: "${{ !!github.event.pull_request }}"
          ISSUE_NUMBER: "${{ github.event.pull_request.number || github.event.issue.number }}"
          REPOSITORY: "${{ github.repository }}"
          ADDITIONAL_CONTEXT: "${{ inputs.additional_context }}"
        with:
          gcp_location: "${{ vars.GOOGLE_CLOUD_LOCATION }}"
          gcp_project_id: "${{ vars.GOOGLE_CLOUD_PROJECT }}"
          gcp_service_account: "${{ vars.SERVICE_ACCOUNT_EMAIL }}"
          gcp_workload_identity_provider: "${{ vars.GCP_WIF_PROVIDER }}"
          gemini_api_key: "${{ secrets.GEMINI_API_KEY }}"
          gemini_cli_version: "${{ vars.GEMINI_CLI_VERSION }}"
          gemini_debug: "${{ fromJSON(vars.GEMINI_DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}"
          gemini_model: "${{ vars.GEMINI_MODEL }}"
          google_api_key: "${{ secrets.GOOGLE_API_KEY }}"
          use_gemini_code_assist: "${{ vars.GOOGLE_GENAI_USE_GCA }}"
          use_vertex_ai: "${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}"
          upload_artifacts: "${{ vars.UPLOAD_ARTIFACTS }}"
          workflow_name: "gemini-invoke"
          settings: "{\n  \"model\": {\n    \"maxSessionTurns\": 100\n  },\n  \"telemetry\": {\n    \"enabled\": true,\n    \"target\": \"local\",\n    \"outfile\": \".gemini/telemetry.log\"\n  },\n  \"mcpServers\": {\n    \"github\": {\n    \"command\": \"docker\",\n    \"args\": [\n      \"run\",\n      \"-i\",\n      \"--rm\",\n      \"-e\",\n      \"GITHUB_PERSONAL_ACCESS_TOKEN\",\n        \"ghcr.io/github/github-mcp-server :v0.27.0\"  \n    ],\n    \"includeTools\": [ \n      \"add_issue_comment\",\n      \"issue_read\",\n      \"list_issues\",\n      \"search_issues\",\n      \"create_pull_request\",\n      \"pull_request_read\",\n      \"list_pull_requests\",\n      \"search_pull_requests\",\n      \"create_branch\",\n      \"create_or_update_file\",\n      \"delete_file\",\n      \"fork_repository\",\n      \"get_commit\",\n      \"get_file_contents\",\n      \"list_commits\",\n      \"push_files\",\n      \"search_code\"\n    ],\n    \"env\": {\n      \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"${GITHUB_TOKEN}\"\n    }\n  },\n  \"lsp-nix\": {\n    \"command\": \"npx\",\n    \"args\": [\n      \"-y\",\n      \"@isaacphi/mcp-language-server\",\n      \"--workspace\",\n      \".\",\n      \"--lsp\",\n      \"nil\"\n    ]\n  },\n  \"ast-grep\": {\n    \"command\": \"docker\",\n    \"args\": [\n      \"run\",\n      \"--rm\",\n      \"-i\",\n      \"-v\",\n      \".:/workspace\",\n      \"-w\",\n      \"/workspace\",\n      \"mcp/ast-grep\"\n    ]\n  },\n  \"fetch\": {\n    \"command\": \"npx\",\n    \"args\": [\n      \"-y\",\n      \"@modelcontextprotocol/server-fetch\"\n    ]\n  },\n  \"nixos\": {\n    \"command\": \"docker\",\n    \"args\": [\n      \"run\",\n      \"--rm\",\n      \"-i\",\n      \"ghcr.io/utensils/mcp-nixos\"\n    ]\n  },\n  \"sequential-thinking\": {\n    \"command\": \"npx\",\n    \"args\": [\n      \"-y\",\n      \"@modelcontextprotocol/server-sequential-thinking\"\n    ]\n  }\n}\n\"tools\": {\n  \"core\": [\n    \"run_shell_command(cat)\",\n    \"run_shell_command(echo)\",\n    \"run_shell_command(grep)\",\n    \"run_shell_command(head)\",\n    \"run_shell_command(tail)\"\n  ]\n}"
          prompt: "/gemini-invoke"
